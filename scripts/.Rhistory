reads <- "C:/Users/P016182/Downloads/chr6_and_unmapped_reads.tsv"
# Read the TSV summarizing reads (read ID, cell barcode, UMI, reference, position)
reads <- utils::read.table(file = reads_overview, header = FALSE, sep = "\t")
# Read the TSV summarizing reads (read ID, cell barcode, UMI, reference, position)
reads <- utils::read.table(file = reads, header = FALSE, sep = "\t")
View(reads)
base::colnames(reads) <- base::c("read.id", "cell.barcode", "umi", "chr", "pos")
gtf <- "C:/Users/P016182/Downloads/genes.gtf.gz"
alignments <- "C:/Users/P016182/Downloads/chr6_and_unmapped_alignments.tsv"
# Read the vsearch alignment TSV file (no header) and assign column names
alignments <- utils::read.table(file = alignment_file, header = FALSE, sep = "\t")
# Read the vsearch alignment TSV file (no header) and assign column names
alignments <- utils::read.table(file = alignments, header = FALSE, sep = "\t")
base::colnames(alignments) <- base::c("read.id", "allele", "match", "n.mismatches", "n.gaps", "start", "end")
View(alignments)
# Extract the HLA gene name (everything before the "*")
alignments$gene <- base::sub(pattern = "\\*.*$", replacement = "", alignments$allele)
# Split alignments by read ID to process reads individually
split_alignments <- base::split(x = alignments, f = alignments$read.id)
# Apply filtering rules:
# - If a read has only 1 alignment, keep it.
# - If a read has multiple alignments:
#   - Keep only if all alignments map to the same HLA gene (collapse to gene level)
#   - Remove the read if alignments map to different genes
alignments_filtered <- base::lapply(X = split_alignments, FUN = function(alignment){
# Single alignment: keep as is
if(base::nrow(alignment) == 1){return(alignment)}
# Multiple alignments: check gene consistency
if(base::nrow(alignment) > 1){
# All alignments map to the same gene → collapse to gene
if(base::length(x = base::unique(x = alignment$gene)) == 1){alignment$allele <- alignment$gene; return(alignment[1, ])}
# Alignments map to different genes → discard read
if(base::length(x = base::unique(x = alignment$gene)) > 1){return(NULL)}
}
})
# Combine filtered alignments back into a single data frame
alignments <- base::do.call(what = base::rbind, args = alignments_filtered)
# Merge filtered alignments with read metadata by read ID
alignments <- base::merge(x = alignments, y = reads, by = "read.id", all.x = TRUE)
# Remove reads data frame to free memory
base::rm(reads)
gc()
# Import the Gencode GTF annotation file as a data frame
gtf <- base::as.data.frame(rtracklayer::import(glue::glue("{output_dir}/{gencode_dir}/Homo_sapiens.GRCh38.dna.primary_assembly.gtf.gz"), format = "gtf"))
# Import the Gencode GTF annotation file as a data frame
gtf <- base::as.data.frame(rtracklayer::import(con = gtf, format = "gtf"))
View(gtf)
#
gtf <- gtf[gtf$type == "gene", ]
#
gtf <- gtf[gtf$type == "gene" & gtf$gene_type %in% base::c("protein_coding", "protein_coding_LoF", "lncRNA", "IG_C_gene", "IG_D_gene", "IG_J_gene", "IG_LV_gene", "IG_V_gene", "IG_V_pseudogene", "IG_J_pseudogene", "IG_C_pseudogene", "TR_C_gene", "TR_D_gene", "TR_J_gene", "TR_V_gene", "TR_V_pseudogene", "TR_J_pseudogene") & gtf$tag != "readthrough_transcript" & gtf$seqnames == "chr6", ]
# Import the Gencode GTF annotation file as a data frame
gtf <- base::as.data.frame(rtracklayer::import(con = gtf, format = "gtf"))
gtf <- "C:/Users/P016182/Downloads/genes.gtf.gz"
#
gtf <- gtf[gtf$type == "gene" & gtf$gene_type %in% base::c("protein_coding", "protein_coding_LoF", "lncRNA", "IG_C_gene", "IG_D_gene", "IG_J_gene", "IG_LV_gene", "IG_V_gene", "IG_V_pseudogene", "IG_J_pseudogene", "IG_C_pseudogene", "TR_C_gene", "TR_D_gene", "TR_J_gene", "TR_V_gene", "TR_V_pseudogene", "TR_J_pseudogene") & gtf$seqnames == "chr6", ]
# Import the Gencode GTF annotation file as a data frame
gtf <- base::as.data.frame(rtracklayer::import(con = gtf, format = "gtf"))
gc()
alignments <- "C:/Users/P016182/Downloads/chr6_and_unmapped_alignments.tsv"
# Read the vsearch alignment TSV file (no header) and assign column names
alignments <- utils::read.table(file = alignments, header = FALSE, sep = "\t")
base::colnames(alignments) <- base::c("read.id", "allele", "match", "n.mismatches", "n.gaps", "start", "end")
# Extract the HLA gene name (everything before the "*")
alignments$hla.gene <- base::sub(pattern = "\\*.*$", replacement = "", alignments$allele)
# Split alignments by read ID to process reads individually
split_alignments <- base::split(x = alignments, f = alignments$read.id)
rm(split_alignments)
gc()
# Split alignments by read ID to process reads individually
alignments_split_by_read <- base::split(x = alignments, f = alignments$read.id)
# Apply filtering rules:
# - If a read has only 1 alignment, keep it.
# - If a read has multiple alignments:
#   - Keep only if all alignments map to the same HLA gene (collapse to gene level)
#   - Remove the read if alignments map to different genes
alignments_filtered <- base::lapply(X = alignments_split_by_read, FUN = function(alignment){
# Single alignment: keep as is
if(base::nrow(alignment) == 1){return(alignment)}
# Multiple alignments: check gene consistency
if(base::nrow(alignment) > 1){
# All alignments map to the same gene → collapse to gene
if(base::length(x = base::unique(x = alignment$hla.gene)) == 1){alignment$allele <- alignment$hla.gene; return(alignment[1, ])}
# Alignments map to different genes → discard read
if(base::length(x = base::unique(x = alignment$hla.gene)) > 1){return(NULL)}
}
})
# Combine filtered alignments back into a single data frame
alignments_filtered <- base::do.call(what = base::rbind, args = alignments_filtered)
View(alignments_filtered)
reads <- "C:/Users/P016182/Downloads/chr6_and_unmapped_reads.tsv"
# Read the TSV summarizing reads (read ID, cell barcode, UMI, reference, position)
reads <- utils::read.table(file = reads, header = FALSE, sep = "\t")
base::colnames(reads) <- base::c("read.id", "cell.barcode", "umi", "chr", "pos")
# Merge filtered alignments with read metadata by read ID
alignments <- base::merge(x = alignments, y = reads, by = "read.id", all.x = TRUE)
# Remove reads data frame to free memory
base::rm(reads)
# Import the Gencode GTF annotation file as a data frame
gtf <- base::as.data.frame(rtracklayer::import(con = gtf, format = "gtf"))
gtf <- "C:/Users/P016182/Downloads/genes.gtf.gz"
# Import the Gencode GTF annotation file as a data frame
gtf <- base::as.data.frame(rtracklayer::import(con = gtf, format = "gtf"))
# Read the TSV summarizing reads (read ID, cell barcode, UMI, reference, position)
reads <- utils::read.table(file = reads, header = FALSE, sep = "\t")
reads = "C:/Users/P016182/Downloads/chr6_and_unmapped_reads.tsv"
# Read the TSV summarizing reads (read ID, cell barcode, UMI, reference, position)
reads <- utils::read.table(file = reads, header = FALSE, sep = "\t")
base::colnames(reads) <- base::c("read.id", "cell.barcode", "umi", "chr", "pos")
# Merge filtered alignments with read metadata by read ID
alignments_filtered <- base::merge(x = alignments_filtered, y = reads, by = "read.id", all.x = TRUE)
# Remove reads data frame to free memory
base::rm(reads)
gc()
View(gtf)
#
gtf <- gtf[gtf$type == "gene" & gtf$seqnames == "chr6", base::c("start", "end", "gene_name")]
View(alignments_filtered)
?return
pos = 32444812
#
genes <- gtf[gtf$start <= pos & gtf$end >= pos, "gene_name"]
genes
pos <- 12
#
genes <- gtf[gtf$start <= pos & gtf$end >= pos, "gene_name"]
genes
length(genes)
#
alignments_filtered$gene <- base::sapply(X = alignments_filtered$pos, FUN = function(pos){
#
if(pos == 0){return("")}
#
if(pos != 0){
#
genes <- gtf[gtf$start <= pos & gtf$end >= pos, "gene_name"]
#
if(base::length(x = genes) == 1){return(genes)}
#
if(base::length(x = genes) != 1){return("")}
}
})
View(alignments_filtered)
alignments_filtered$chr[alignments_filtered$chr == "*"] <- NA
alignments_filtered$pos[alignments_filtered$pos == "0"] <- NA
alignments_filtered$gene[alignments_filtered$gene == ""] <- NA
table(alignments_filtered$gene)
#
alignments_filtered <- alignments_filtered[base::is.na(alignments_filtered$gene) | base::grepl(pattern = "HLA-", x = alignments_filtered$gene), ]
table(alignments_filtered$gene)
View(alignments_filtered)
# Split alignments by read ID to process reads individually
alignments_split_by_umi<- base::split(x = alignments_filtered, f = base::c(alignments_filtered$cell.barcode, alignments_filtered$umi))
rm(alignments_split_by_umi)
#
alignments_filtered <- alignments_filtered |>
dplyr::group_by(cell.barcode, umi) |>
dplyr::filter(dplyr::n_distinct(hla.gene) == 1) |>
dplyr::ungroup
#
alignments_filtered <- alignments_filtered |>
dplyr::group_by(cell.barcode, umi) |>
dplyr::filter(dplyr::n_distinct(hla.gene) == 1) |>
dplyr::ungroup()
alignment_file <- "C:/Users/P016182/Downloads/chr6_and_unmapped_reads_realigned.tsv"
alignment_file
base::sub(pattern = "\\.tsv$", replacement = "_filtered.tsv", alignment_file)
